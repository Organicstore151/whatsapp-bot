const express = require("express");
const bodyParser = require("body-parser");
const twilio = require("twilio");
require("dotenv").config();

const app = express();
const PORT = process.env.PORT || 3000;

app.use(bodyParser.urlencoded({ extended: false }));

const client = twilio(
  process.env.TWILIO_ACCOUNT_SID,
  process.env.TWILIO_AUTH_TOKEN
);

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°
app.get("/", (req, res) => {
  res.send("âœ… WhatsApp Ð±Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚");
});

// Webhook Twilio
app.post("/webhook", async (req, res) => {
  const from = req.body.From;
  const body = req.body.Body;

  console.log("ðŸ“© Ð’Ñ…Ð¾Ð´ÑÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚:", from, "| Ð¢ÐµÐºÑÑ‚:", body);

  try {
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°
    await client.messages.create({
      from: process.env.TWILIO_WHATSAPP_NUMBER,
      to: from,
      contentSid: process.env.TEMPLATE_SID
    });

    console.log("âœ… Ð¨Ð°Ð±Ð»Ð¾Ð½ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½");

    // ÐÐµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð½Ð¸ÐºÐ°ÐºÐ¾Ð¹ Ñ‚ÐµÐºÑÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ "OK"
    res.status(204).end();
  } catch (error) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°:", error);
    res.status(500).send("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°");
  }
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
app.listen(PORT, () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://localhost:${PORT}`);
});

